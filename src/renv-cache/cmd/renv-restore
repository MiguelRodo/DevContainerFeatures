#!/usr/bin/env bash

# Exit immediately if an error occurs
set -e

# Function to display usage information
usage() {
    echo "  Usage: $(basename "$0") [OPTIONS]"
    echo ""
    echo "Description:"
    echo "  This script restores and/or updates R packages using renvvv functions."
    echo "Options:"
    echo "  -d, --directory DIRECTORY        Project directory containing 'renv.lock' file. Default is current directory."
    echo "  -r, --restore                    Run restoration. Default is true."
    echo "  -u, --update                     Run update. Default is false."
    echo "  -e, --exclude PKG1,PKG2          Comma-separated list of packages to exclude from restore/update."
    echo "  -p, --pak                        Use pak (passed to underlying functions if supported)."
    echo "  -D, --debug                      Enable debug mode."
    echo "  --debug-renv                     Enable debug mode for renv."
    echo "  -h, --help                       Display this help message."
    exit "${1:-0}"
}

PROJECT_DIR="."
RESTORE=false
UPDATE=false
PKG_EXCLUDE=""
DEBUG=false
USE_PAK=false
DEBUG_RENV=false

# Parse command-line arguments
while [ "$#" -gt 0 ]; do
    case "$1" in
        -r|--restore)
            RESTORE=true
            shift
            ;;
        -u|--update)
            UPDATE=true
            shift
            ;;
        -e|--exclude)
             if [ -n "${2:-}" ] && case "$2" in -*) false;; *) true;; esac; then
                PKG_EXCLUDE="$2"
                shift 2
            else
                shift
            fi
            ;;
        -d|--directory)
            if [ -n "${2:-}" ] && case "$2" in -*) false;; *) true;; esac; then
                PROJECT_DIR="$2"
                shift 2
            else
                echo "[ERROR] --directory requires a directory path argument."
                usage 1
            fi
            ;;
        -p|--pak)
            USE_PAK=true
            shift
            ;;
        -D|--debug)
            DEBUG=true
            shift
            ;;
        --debug-renv)
            DEBUG_RENV=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo "[ERROR] Unknown parameter passed: $1"
            usage 1
            ;;
    esac
done

debug() {
    if [ "$DEBUG" = true ]; then
        echo "DEBUG: $1"
    fi
}

set_debug_renv() {
    if [ "$DEBUG_RENV" = true ]; then
        export RENV_CONFIG_DEBUG=true
    fi
}

debug "Running renv-restore"
debug "PROJECT_DIR: $PROJECT_DIR"
debug "RESTORE: $RESTORE"
debug "UPDATE: $UPDATE"
debug "PKG_EXCLUDE: $PKG_EXCLUDE"
debug "USE_PAK: $USE_PAK"
debug "DEBUG_RENV: $DEBUG_RENV"

install_renv() {
    echo "Restoring original renv version"
    Rscript -e "if (!requireNamespace('renv', quietly = TRUE)) install.packages('renv', repos = 'https://cloud.r-project.org')"
}

# Function to install renvvv
install_renvvv() {
    echo "Installing renvvv..."
    # Ensure remotes is installed
    Rscript -e "if (!requireNamespace('remotes', quietly = TRUE)) install.packages('remotes', repos = 'https://cloud.r-project.org')"
    
    # Install renvvv
    Rscript -e "remotes::install_github('MiguelRodo/renvvv', upgrade = 'never')"
}

# Activate project
renv_activate() {
    echo "Activating project"
    set_debug_renv
    Rscript -e "
        tryCatch(
            renv::activate(),
            error = function(e) {
                message('[WARN] Activation threw error: ', e)
            }
        )"
    echo "[OK] Activation process attempted"
    echo "---------------------------------------------"
}

r_lib_paths() {
    # echo out R library paths
    set_debug_renv
    debug "R library paths:"
    R_LIB_PATHS=$(Rscript -e 'cat(.libPaths(), sep="\n")' 2>/dev/null | tr -d '\r')

    if [ $? -eq 0 ] && [ -n "$R_LIB_PATHS" ]; then
        debug "$R_LIB_PATHS"
    else
        debug "Failed to retrieve R library paths."
    fi
}

restore_renv() {
    echo "Restoring original renv version"
    set_debug_renv
    Rscript -e "
        tryCatch(
            renv::restore(packages = 'renv', transactional = TRUE),
            error = function(e) {
                message('[WARN] Restore failed: ', e)
            }
        )"
}

install_pak() {
    echo "Installing pak"
    set_debug_renv
    local renv_config_pak_orig="$RENV_CONFIG_PAK_ENABLED"
    if [ "$renv_config_pak_orig" = "true" ]; then
        export RENV_CONFIG_PAK_ENABLED=false
    fi
    local version="stable"
    Rscript -e "
    tryCatch(
        {
            if (isFALSE(requireNamespace('pak', quietly = TRUE))) {
                message('pak not found. Installing pak...')
                install.packages(\"pak\", repos = sprintf(\"https://r-lib.github.io/p/pak/"${version}"/%s/%s/%s\", .Platform\$pkgType, R.Version()\$os, R.Version()\$arch))
            } else {
                message('[OK] pak is already installed.')
            }
        },
        error = function(e) {
            message('[WARN] Installation failed: ', e)
        }
    )"
    if [ "$renv_config_pak_orig" = "true" ]; then
        export RENV_CONFIG_PAK_ENABLED=true
    fi
    echo "[OK] Installation process attempted"
    echo "---------------------------------------------"
}

install_pkg() {
    echo "Installing $1"
    set_debug_renv
    local renv_config_pak_orig="$RENV_CONFIG_PAK_ENABLED"
    if [ "$renv_config_pak_orig" = "true" ]; then
        export RENV_CONFIG_PAK_ENABLED=false
    fi
    Rscript -e "
    tryCatch(
        {
            if (isFALSE(requireNamespace('$1', quietly = TRUE))) {
                message('$1 not found. Installing $1...')
                utils::install.packages('$1', repos = 'https://cloud.r-project.org')
            } else {
                message('[OK] $1 is already installed.')
            }
        },
        error = function(e) {
            message('[WARN] Installation failed: ', e)
        }
    )"
    if [ "$renv_config_pak_orig" = "true" ]; then
        export RENV_CONFIG_PAK_ENABLED=true
    fi
    echo "[OK] Installation process attempted"
    echo "---------------------------------------------"
}

install_pak_bioc() {
    echo "Installing pak and BiocManager"
    set_debug_renv
    install_pak
    install_pkg BiocManager
}

install_gitcreds() {
    echo "Installing gitcreds for authentication"
    set_debug_renv
    
    # Check if gitcreds is already installed in the project library
    local gitcreds_installed=$(Rscript -e "cat(isTRUE(requireNamespace('gitcreds', quietly = TRUE)))" 2>/dev/null || echo "FALSE")
    
    if [ "$gitcreds_installed" = "TRUE" ]; then
        echo "[OK] gitcreds is already installed."
        return 0
    fi
    
    echo "gitcreds not found. Installing gitcreds..."
    
    # Temporarily disable pak for gitcreds installation to avoid conflicts
    local renv_config_pak_orig="$RENV_CONFIG_PAK_ENABLED"
    if [ "$renv_config_pak_orig" = "true" ]; then
        export RENV_CONFIG_PAK_ENABLED=false
    fi
    
    # Install gitcreds - don't fail if this doesn't work
    Rscript -e "
    tryCatch(
        {
            if (isFALSE(requireNamespace('gitcreds', quietly = TRUE))) {
                message('Installing gitcreds from CRAN...')
                utils::install.packages('gitcreds', repos = 'https://cloud.r-project.org')
                message('[OK] gitcreds installed successfully.')
            } else {
                message('[OK] gitcreds is already installed.')
            }
        },
        error = function(e) {
            message('[WARN] gitcreds installation failed: ', e)
            message('[WARN] Continuing without gitcreds - GitHub token authentication will still be attempted.')
        }
    )" || {
        echo "[WARN] gitcreds installation encountered an error, but continuing..."
    }
    
    # Restore original pak setting
    if [ "$renv_config_pak_orig" = "true" ]; then
        export RENV_CONFIG_PAK_ENABLED=true
    fi
    
    echo "---------------------------------------------"
}

restore() {
    echo "Attempting to restore/update packages using renvvv"
    set_debug_renv

    # Export PKG_EXCLUDE for use in R script
    export PKG_EXCLUDE

    # Determine which renvvv function to call
    local renvvv_function=""
    if [ "$RESTORE" = "true" ] && [ "$UPDATE" = "true" ]; then
        renvvv_function="renvvv::renvvv_restore_and_update(skip = skip_packages)"
        echo "[INFO] Both restore and update requested - using renvvv_restore_and_update()"
    elif [ "$RESTORE" = "true" ]; then
        renvvv_function="renvvv::renvvv_restore(skip = skip_packages)"
        echo "[INFO] Restore requested - using renvvv_restore()"
    elif [ "$UPDATE" = "true" ]; then
        renvvv_function="renvvv::renvvv_update(skip = skip_packages)"
        echo "[INFO] Update requested - using renvvv_update()"
    else
        echo "[WARN] Neither restore nor update requested. Skipping."
        return 0
    fi

    # Use renvvv function
    Rscript -e "
        if (!requireNamespace('renvvv', quietly = TRUE)) {
            stop('renvvv not found. Please ensure it was installed by the feature.')
        }

        # Activate the project first to ensure correct paths
        if (file.exists('renv/activate.R')) {
            source('renv/activate.R')
        }

        # Parse packages to skip from environment variable
        pkg_exclude_str <- Sys.getenv('PKG_EXCLUDE', '')
        skip_packages <- if (nzchar(pkg_exclude_str)) {
            # Split by comma and trim whitespace
            trimws(unlist(strsplit(pkg_exclude_str, ',')))
        } else {
            character(0)
        }

        if (length(skip_packages) > 0) {
            message('Skipping packages: ', paste(skip_packages, collapse = ', '))
        }

        tryCatch(
            $renvvv_function,
            error = function(e) {
                message('[WARN] renvvv operation failed: ', e)
                quit(status = 1)
            }
        )
    "
    echo "[OK] Restore/update process attempted"
    echo "---------------------------------------------"
}

run_custom_scripts() {
    set_debug_renv
    if [ -f "renv-cache-renv.sh" ]; then
        echo "Found shell script"
        if ! ./renv-cache-renv.sh "$PKG_EXCLUDE"; then
            echo "[WARN] Project-specific shell script failed"
            echo "---------------------------------------------"
        fi
    fi

    if [ -f "renv-cache-renv.R" ]; then
        echo "Found R script"
        cd "$PROJECT_DIR"
        if ! Rscript renv-cache-renv.R "$PKG_EXCLUDE"; then
            echo "[WARN] Project-specific R script failed"
            echo "---------------------------------------------"
        fi
    fi
}

main() {
    if [ "$RESTORE" = "false" ] && [ "$UPDATE" = "false" ]; then
        echo "Skipping restore and update as both are disabled."
        exit 0
    fi

    ORIG_DIR=$(pwd)
    PROJECT_NAME=$(basename "$PROJECT_DIR")
    echo "Processing project: $PROJECT_NAME"
    trap 'cd "$ORIG_DIR"' EXIT
    cd "$PROJECT_DIR"

    if [ ! -f "renv.lock" ]; then
        echo "[WARN] No renv.lock found in $PROJECT_DIR. Skipping."
        exit 0
    fi

    r_lib_paths
    install_renv
    renv_activate
    r_lib_paths
    install_gitcreds
    install_pak_bioc
    install_renvvv
    restore
    run_custom_scripts
    echo "[OK] Finished processing project: $PROJECT_NAME"
    echo "---------------------------------------------"
}

main
